<ROSETTASCRIPTS>

  <SCOREFXNS>
    # Centroid-level score function is used to score after NubInitio and in case chainbreak closure is needed.
    <ScoreFunction name="centroid" weights="cen_std" patch="score4L" />
    # Full Atom-level score function is used to repack disulfides in NubInitio and guide FastDesign.
    <ScoreFunction name="fullatom" weights="talaris2014" />
  </SCOREFXNS>

  <RESIDUE_SELECTORS>
    <xi:include href="xml_pieces/selectors.xml" />    # Standard FFL ResidueSelectors.
    # Template Scaffold Selectors
    <Chain name="chB" chains="B" />                   # Template Chain (there can only be one!).
                                                      # Here it dubs as design chain too.
    <Not name="!chB" selector="chB" />

    # Template Scaffold AND Motif Selectors (insertion over itself)
    <Index name="motif1" resnums="34B-36B" />
    <Index name="motif2" resnums="46B-48B" />
    <Index name="motif3" resnums="91B-95B" />
    <Index name="motif4" resnums="101B-103B" />
    <Or name="insertion" selectors="motif1,motif2,motif3,motif4" />

    # Regions that we want to keep unconstrained
    <Index name="uc1" resnums="38B-44B" />
    <Index name="uc2" resnums="51B-63B" />
    <Index name="uc3" resnums="96B-100B" />
    <Or name="unconstrained" selectors="uc1,uc2,uc3" />
  </RESIDUE_SELECTORS>

  <MOVE_MAP_FACTORIES>
    <xi:include href="xml_pieces/movemap.xml" />      # Standard FFL MoveMap
  </MOVE_MAP_FACTORIES>

  <TASKOPERATIONS>
    <xi:include href="xml_pieces/taskoperators.xml" /># Standard FFL TaskOperators
  </TASKOPERATIONS>

  <FILTERS>
    # We will check at the end the final RMSD between the template and the Design
    # Nothing comming out of the NubInitioMover will have non-peptide residues,
    # so the chAprot selector is not necessary for it (not decrimental, either).
    <RmsdFromResidueSelectorFilter name="final_rmsd" confidence="0" threshold="5"
        reference_name="template_pose" reference_selector="chB"
        query_selector="chB" />
    # Make sure to get an evaluation of the design alone
    <ConstraintFulfilmentFilter name="unf_atompair" distance="1" angle="0" dihedral="0" confidence="0" />
    <ConstraintFulfilmentFilter name="unf_angle" distance="0" angle="1" dihedral="0" confidence="0" />
    <ConstraintFulfilmentFilter name="unf_dihedral" distance="0" angle="0" dihedral="1" confidence="0" />
  </FILTERS>

  <MOVERS>
    # We will save the template, as it is also our target, here.
    <SavePoseMover name="saveTemplate" restore_pose="0" reference_name="template_pose" />
    # This is one of the alternatives to load the target motif's pdb file.
    <SavePoseMover name="load_target" reference_name="target_pose" pdb_file="../4zqk3_0001.pdb" />
    # Both to create the fragments needed for NubInitio as well as for the NubInitio itself,
    # only one-chain templates can be considered, so we'll need to delete the rest.
    <DeleteRegionMover name="removeExtraChains" residue_selector="!chB" />
    # The creates the fragments (if they need to be created) or loads them from a file
    # into the DataMap with the "frags" identifier (that needs to be specified in the NubInitio).
    <StructFragmentMover name="FragmentPicker" prefix="frags"
      vall_file="database/vall.jul19.2011.gz" output_frag_files="1"
      small_frag_file="frags.200.3mers" large_frag_file="frags.200.9mers" />
    # Constraints have to be used to guide the ab initio folding.
    <AddConstraints name="addCST" >
      <AtomPairConstraintGenerator name="atompairCST" sd="4.0" ca_only="true"
        use_harmonic="true" unweighted="true" min_seq_sep="6" max_distance="40" residue_selector="chB" />
    </AddConstraints>
    <ReleaseConstraintFromResidueMover name="releaseCST" residue_selector="unconstrained" />
    <SheetConstraintGenerator name="sheetCST" blueprint="../4zqk3_0001.blue" dist="5.5" dist_tolerance="1.0" angle_tolerance="0.35" bb_dihedral_tolerance="0.52" weight="2.0" />
    <CstInfoMover name="showCST" dump_cst_file="constraintbench.cst" recursive="true" />

    # The NubInitio folding is done here.
    <NubInitioMover name="FFL" fragments_id="frags" template_motif_selector="insertion" use_cst="true"
        rmsd_threshold="5" centroid_scorefxn="centroid" fullatom_scorefxn="fullatom" break_side_ramp="true"
         >
      <Nub reference_name="target_pose" residue_selector="insertion" />
    </NubInitioMover>

    # Edit the sequence to stabilize the protein
    <FastDesign name="DesignRelax" scorefxn="fullatom"
               task_operations="FFLMOTIF_TASKOP,FFLTEMPLATE_TASKOP,FFLTEMPLATE_DISULFIDES"
               repeats="1" delete_virtual_residues_after_FastRelax="true"
               movemap_factory="FFLSTANDARD_MOVEMAP" >
    </FastDesign>

    <ResidueLabelsToPymolSelectionMover name="pymolselect"  pdb_count="true" />

  </MOVERS>
  <APPLY_TO_POSE>
  </APPLY_TO_POSE>
  <PROTOCOLS>
    # Preparing the Template
    <Add mover="saveTemplate" />
    <Add mover="removeExtraChains" />
    <Add mover="FragmentPicker" />
    <Add mover="addCST" />
    <Add mover="sheetCST" />
    <Add mover="releaseCST" />
    <Add mover="reportCST" />
    # Fold
    <Add mover="FFL" />
    # Design
    <Add mover="DesignRelax" />
    # Evaluate
    <Add filter="final_rmsd" />
    <Add filter="unf_atompair" />
    <Add filter="unf_angle" />
    <Add filter="unf_dihedral" />
    <Add mover="pymolselect" />
  </PROTOCOLS>
  <OUTPUT />
</ROSETTASCRIPTS>

